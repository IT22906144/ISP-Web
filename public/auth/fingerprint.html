<!DOCTYPE html>
<html>
<head>
  <title>Fingerprint Authentication</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h2>Biometric Authentication</h2>
    <p>Please use your fingerprint or device biometric</p>
    <button onclick="authenticate()">Authenticate</button>
  </div>

  <script>
    async function authenticate() {
      if (!window.PublicKeyCredential) {
        alert("WebAuthn not supported by your browser.");
        return;
      }

      // Step 1: Fetch challenge from server
      const challengeResponse = await fetch('/api/auth-challenge', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: localStorage.getItem("username") }) // store username in login step
      });
      const publicKey = await challengeResponse.json();

      try {
        const credential = await navigator.credentials.get({ publicKey });

        const assertionResponse = {
          id: credential.id,
          rawId: arrayBufferToBase64(credential.rawId),
          response: {
            authenticatorData: arrayBufferToBase64(credential.response.authenticatorData),
            clientDataJSON: arrayBufferToBase64(credential.response.clientDataJSON),
            signature: arrayBufferToBase64(credential.response.signature),
            userHandle: credential.response.userHandle ? arrayBufferToBase64(credential.response.userHandle) : null,
          },
          type: credential.type,
        };

        // Step 2: Send assertion to server for verification
        const verifyResponse = await fetch('/api/verify-auth', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            username: localStorage.getItem("username"),
            assertion: assertionResponse
          })
        });

        const result = await verifyResponse.json();
        if (result.success) {
          alert("Authentication successful!");
          window.location.href = 'token.html';
        } else {
          alert("Authentication failed.");
        }
      } catch (err) {
        console.error(err);
        alert("Authentication error.");
      }
    }

    function arrayBufferToBase64(buffer) {
      return btoa(String.fromCharCode(...new Uint8Array(buffer)));
    }
  </script>
</body>
</html>
